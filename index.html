<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Salesforce Lightning Out 2.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/design-system/2.20.1/styles/salesforce-lightning-design-system.min.css" />
    <script type="text/javascript" async src="https://da1767753962898.my.salesforce.com/lightning/lightning.out.latest/index.iife.prod.js"></script>
    <style>
        #lwc-container { margin-top: 20px; padding: 20px; border: 1px dashed #ccc; min-height: 200px; }
    </style>
</head>
<body>
    <h1>Salesforce LWC 연동 (2.0 방식)</h1>

    <div id="container">
        <button id="login-button" onclick="login()" style="display:none; padding:10px; background:#0070d2; color:white; border:none; border-radius:4px;">Salesforce 로그인</button>
        
        <lightning-out-application id="lo-app" app-id="1UsHu000000sgYSKAY" components="c-test-lightning"></lightning-out-application>
        
        <div id="lwc-container">
            <p id="loading-text">기다려주세요. 컴포넌트를 불러오는 중입니다...</p>
        </div>
    </div>

    <script>
        const CLIENT_ID = '3MVG9VTfpJmxg1yjLWfz5Za8o4IE9zddnTJHwQZNFsRmWzqtir_d48DdzPsIsjLcQF6vYFERqVQUeXW2713w_';
        const SF_DOMAIN = 'https://da1767753962898.my.salesforce.com';
        const REDIRECT_URI = 'https://jeon-heejae.github.io/test-website/callback.html';

        const token = localStorage.getItem('sf_token');

        if (!token) {
            document.getElementById('login-button').style.display = 'block';
            document.getElementById('loading-text').style.display = 'none';
        } else {
            initLightningOut();
        }

        function login() {
            const authUrl = `${SF_DOMAIN}/services/oauth2/authorize?response_type=token&client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}`;
            window.location.href = authUrl;
        }

        function initLightningOut() {
            const frontdoorUrl = `${SF_DOMAIN}/secur/frontdoor.jsp?sid=${token}`;
            const loApp = document.getElementById('lo-app');

            // 1. 세션 연결 시작
            loApp.setAttribute('frontdoor-url', frontdoorUrl);

            // 2. 앱 준비 완료 시 실행
            loApp.addEventListener('lo.application.ready', () => {
                console.log("Lightning Out Application Ready!");
                
                // 3. 컴포넌트 태그 동적 생성 및 주입
                const lwcContainer = document.getElementById('lwc-container');
                lwcContainer.innerHTML = ''; // 로딩 메시지 삭제

                const myLwc = document.createElement('c-test-lightning');
                myLwc.setAttribute('recordId', '001Hu00003xZax0IAC'); // @api recordId 에 전달
                
                lwcContainer.appendChild(myLwc);
            });

            // 오류 감지
            loApp.addEventListener('lo.application.error', (e) => {
                console.error("App Error:", e.detail.message);
                document.getElementById('loading-text').innerText = "오류 발생: " + e.detail.message;
            });

            // 최종 렌더링 확인
            loApp.addEventListener('lo.component.ready', () => {
                console.log("Component is now ready and rendered!");
            });
        }
    </script>
</body>
</html>
